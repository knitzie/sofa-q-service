!function(a,b){"use strict";a.define("sofa.QService",function(){function a(a,c){function d(a){return a}function e(a){return i(a)}function f(a){var b=g(),c=0,d=isArray(a)?[]:{};return forEach(a,function(a,e){c++,h(a).then(function(a){d.hasOwnProperty(e)||(d[e]=a,--c||b.resolve(d))},function(a){d.hasOwnProperty(e)||b.reject(a)})}),0===c&&b.resolve(d),b.promise}var g=function(){var f,j,k=[];return j={resolve:function(c){if(k){var d=k;k=b,f=h(c),d.length&&a(function(){for(var a,b=0,c=d.length;c>b;b++)a=d[b],f.then(a[0],a[1],a[2])})}},reject:function(a){j.resolve(i(a))},notify:function(b){if(k){var c=k;k.length&&a(function(){for(var a,d=0,e=c.length;e>d;d++)a=c[d],a[2](b)})}},promise:{then:function(a,b,h){var i=g(),j=function(b){try{i.resolve((a||d)(b))}catch(e){c(e),i.reject(e)}},l=function(a){try{i.resolve((b||e)(a))}catch(d){c(d),i.reject(d)}},m=function(a){try{i.notify((h||d)(a))}catch(b){c(b)}};return k?k.push([j,l,m]):f.then(j,l,m),i.promise},always:function(a){function b(a,b){var c=g();return b?c.resolve(a):c.reject(a),c.promise}function c(c,e){var f=null;try{f=(a||d)()}catch(g){return b(g,!1)}return f&&f.then?f.then(function(){return b(c,e)},function(a){return b(a,!1)}):b(c,e)}return this.then(function(a){return c(a,!0)},function(a){return c(a,!1)})}}}},h=function(b){return b&&b.then?b:{then:function(c){var d=g();return a(function(){d.resolve(c(b))}),d.promise}}},i=function(b){return{then:function(c,d){var f=g();return a(function(){f.resolve((d||e)(b))}),f.promise}}},j=function(b,f,j,k){var l,m=g(),n=function(a){try{return(f||d)(a)}catch(b){return c(b),i(b)}},o=function(a){try{return(j||e)(a)}catch(b){return c(b),i(b)}},p=function(a){try{return(k||d)(a)}catch(b){c(b)}};return a(function(){h(b).then(function(a){l||(l=!0,m.resolve(h(a).then(n,o,p)))},function(a){l||(l=!0,m.resolve(o(a)))},function(a){l||m.notify(p(a))})}),m.promise};return{defer:g,reject:i,when:j,all:f}}return a(function(a){a()},function(a){console.log(a)})})}(sofa);